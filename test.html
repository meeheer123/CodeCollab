<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Code Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/editor/editor.main.css">
  <style>
    #editor {
      width: 100%;
      height: 90vh;
      border: 1px solid #ddd;
    }

    /* Styling the other user's cursor */
    .user-cursor {
      position: absolute;
      width: 2px;
      background-color: red;
      z-index: 100;
    }

    .username-label {
      position: absolute;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 2px 5px;
      font-size: 12px;
      border-radius: 3px;
      z-index: 101;
    }
  </style>
</head>
<body>
  <h1>Collaborative Code Editor</h1>
  <div id="editor"></div>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/loader.js"></script>
  <script>
    // WebSocket connection to the backend server
    const username = "client2"
    const socket = new WebSocket('ws://localhost:8080');
    
    let editor, cursorDecorations = {};

    // Add event listeners for WebSocket connection
    socket.onopen = () => {
      console.log('WebSocket connection established');
    };

    socket.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    socket.onclose = () => {
      console.log('WebSocket connection closed');
    };

    // Initialize Monaco Editor
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor/min/vs' }});
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: "// Start typing your code here...\n",
        language: 'javascript',
        theme: 'vs-dark'
      });

      // Send code updates to the server when content changes
      editor.onDidChangeModelContent(() => {
        const code = editor.getValue();
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: 'code', data: code })); // Send the updated code to WebSocket server
        } else {
          console.warn('WebSocket is not open. Unable to send code.');
        }
      });

      // Send cursor position updates
      editor.onDidChangeCursorPosition((e) => {
        const position = editor.getPosition();
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'cursor',
            data: {
              username: username, // Current user's cursor
              position
            }
          }));
        }
      });

      // Receive updates from the server
      socket.onmessage = (event) => {
        const reader = new FileReader();
        reader.onload = () => {
          const message = JSON.parse(reader.result);
          if (message.type === 'code') {
            processUpdatedCode(message.data);
          } if (message.type === 'cursor') {
            updateCursor(message.data);
          }
        };
        reader.readAsText(event.data); // Read the Blob as text
      };

      function processUpdatedCode(updatedCode) {
        if (updatedCode !== editor.getValue()) {
          console.log('Updating editor with new code');
          editor.setValue(updatedCode);
        }
      }

      function updateCursor(cursorData) {
        const { username, position } = cursorData;
        if (username !== 'client2') { // Ignore the current user's cursor
          showUserCursor(username, position);
        }
      }

      function showUserCursor(username, position) {
        const range = new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column);
        const options = {
          className: `user-cursor`, // Style for the other user's cursor
          stickiness: 1 // Make sure it stays at the cursor position
        };

        // Update or create cursor decorations for this user
        if (cursorDecorations[username]) {
          // Update the existing decoration
          editor.deltaDecorations(cursorDecorations[username], [{
            range,
            options
          }]);
        } else {
          // Create a new decoration
          cursorDecorations[username] = editor.deltaDecorations([], [{
            range,
            options
          }]);
        }

        // Get the pixel position of the cursor
        const cursorCoords = editor.getScrolledVisiblePosition({ lineNumber: position.lineNumber, column: position.column });
        
        if (cursorCoords) {
          // Create or update a label with the username
          let label = document.querySelector(`.username-label[data-username="${username}"]`);
          if (!label) {
            label = document.createElement('div');
            label.className = 'username-label';
            label.dataset.username = username;
            document.body.appendChild(label);
          }
          label.textContent = username;

          const labelOffset = 100;

          // Set label position based on editor's cursor coordinates
          label.style.left = `${cursorCoords.left}px`;
          label.style.top = `${cursorCoords.top + labelOffset}px`;
        }
      }

    });
  </script>
</body>
</html>