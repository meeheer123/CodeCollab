<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeCollab - Collaborative Code Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/editor/editor.main.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --background-color: #f8f9fa;
      --text-color: #333;
      --border-color: #e0e0e0;
      --output-bg-color: #2d3748;
      --output-text-color: #e2e8f0;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .container {
      display: flex;
      height: calc(100vh - 60px);
    }
    #editor {
      width: 60%;
      height: 100%;
      border-right: 1px solid var(--border-color);
    }
    .right-panel {
      width: 40%;
      display: flex;
      flex-direction: column;
    }
    #video-placeholder {
      height: 50%;
      background-color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      font-weight: 500;
      color: #888;
    }
    .output-section {
      height: 50%;
      display: flex;
      flex-direction: column;
      background-color: var(--output-bg-color);
    }
    #run-button {
      padding: 12px 20px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #run-button:hover {
      background-color: #27ae60;
    }
    #output {
      flex-grow: 1;
      padding: 20px;
      white-space: pre-wrap;
      overflow-y: auto;
      font-family: 'Fira Code', monospace;
      font-size: 14px;
      line-height: 1.6;
      color: var(--output-text-color);
      background-color: var(--output-bg-color);
      border-radius: 0 0 4px 4px;
    }
    .output-header {
      background-color: #1a202c;
      color: var(--output-text-color);
      padding: 10px 20px;
      font-weight: 500;
      border-bottom: 1px solid #4a5568;
    }
    .user-cursor {
      position: absolute;
      width: 2px;
      background-color: var(--primary-color);
      z-index: 100;
    }
    .username-label {
      position: absolute;
      background-color: var(--primary-color);
      color: white;
      padding: 2px 5px;
      font-size: 12px;
      border-radius: 3px;
      z-index: 101;
    }
    .header {
      background-color: #ffffff;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 40px;
    }
    .logo {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary-color);
    }
    .user-info {
      font-size: 14px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">CodeCollab</div>
    <div class="user-info">Connected as: <span id="username"></span></div>
  </div>
  <div class="container">
    <div id="editor"></div>
    <div class="right-panel">
      <div id="video-placeholder">Video collaboration coming soon</div>
      <div class="output-section">
        <div class="output-header">Output</div>
        <button id="run-button">Run Code</button>
        <div id="output"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/loader.js"></script>
  <script>
    const username = "user" + Math.floor(Math.random() * 1000);
    document.getElementById('username').textContent = username;

    const clientId = Math.random().toString(36).substr(2, 9);

    const socket = new WebSocket('wss://spectrum-working-surf.glitch.me');
    
    let editor;
    let cursorDecorations = {};
    let isRemoteUpdate = false;

    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor/min/vs' }});
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: "// Start coding here...\n",
        language: 'javascript',
        theme: 'vs-dark',
        fontSize: 14,
        minimap: { enabled: false }
      });

      editor.onDidChangeModelContent((event) => {
        if (isRemoteUpdate) return;
        
        const changes = event.changes;
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'delta',
            data: { changes, username, clientId }
          }));
        }
      });

      editor.onDidChangeCursorPosition((e) => {
        if (isRemoteUpdate) return;

        const position = editor.getPosition();
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'cursor',
            data: { username, position, clientId }
          }));
        }
      });

      socket.onmessage = (event) => {
        if (event.data instanceof Blob) {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const message = JSON.parse(reader.result);
              if (message.data.clientId === clientId) return;

              if (message.type === 'delta') {
                isRemoteUpdate = true;
                applyDeltas(message.data.changes);
                isRemoteUpdate = false;
              } else if (message.type === 'cursor') {
                updateCursor(message.data);
              } else if (message.type === 'run-output') {
                displayOutput(message.data.output);
              }
            } catch (error) {
              console.error('Error parsing WebSocket message:', error);
            }
          };
          reader.readAsText(event.data);
        }
      };

      function applyDeltas(changes) {
        editor.executeEdits(null, changes.map(change => ({
          range: new monaco.Range(
            change.range.startLineNumber, change.range.startColumn,
            change.range.endLineNumber, change.range.endColumn
          ),
          text: change.text,
          forceMoveMarkers: change.forceMoveMarkers
        })));
      }

      function updateCursor(cursorData) {
        const { username, position } = cursorData;
        if (username !== clientId) {
          showUserCursor(username, position);
        }
      }

      function showUserCursor(username, position) {
        const range = new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column);
        const options = {
          className: `user-cursor`,
          stickiness: 1
        };

        if (cursorDecorations[username]) {
          cursorDecorations[username] = editor.deltaDecorations(cursorDecorations[username], [{ range, options }]);
        } else {
          cursorDecorations[username] = editor.deltaDecorations([], [{ range, options }]);
        }

        const cursorCoords = editor.getScrolledVisiblePosition({ lineNumber: position.lineNumber, column: position.column });
        if (cursorCoords) {
          let label = document.querySelector(`.username-label[data-username="${username}"]`);
          if (!label) {
            label = document.createElement('div');
            label.className = 'username-label';
            label.dataset.username = username;
            document.body.appendChild(label);
          }
          label.textContent = username;

          const labelOffset = 20;
          label.style.left = `${cursorCoords.left}px`;
          label.style.top = `${cursorCoords.top + labelOffset}px`;
        }
      }
    });

    socket.onopen = () => console.log('WebSocket connection established');
    socket.onerror = (error) => console.error('WebSocket error:', error);
    socket.onclose = () => console.log('WebSocket connection closed');

    document.getElementById('run-button').addEventListener('click', () => {
      const code = editor.getValue();

      runCodeWithPistonAPI(code)
        .then(output => {
          if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
              type: 'run-output',
              data: { output, username, clientId }
            }));
          }
          displayOutput(output);
        })
        .catch(error => {
          console.error("Error running code:", error);
          displayOutput({ output: error.toString() });
        });
    });

    async function runCodeWithPistonAPI(code) {
      const response = await fetch('https://emkc.org/api/v2/piston/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          language: "javascript",
          files: code,
          version: "*"
        })
      });

      const result = await response.json();
      return result.run ? result.run : { output: 'No output or error occurred.' };
    }

    function displayOutput(output) {
      const outputElement = document.getElementById('output');
      outputElement.textContent = output.output || 'No output';
      outputElement.innerHTML = outputElement.innerHTML.replace(/\n/g, '<br>');
    }
  </script>
</body>
</html>