<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Collaborative Code Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/editor/editor.main.css">
  <style>
    #editor {
      width: 100%;
      height: 80vh;
      border: 1px solid #ddd;
    }
    #run-button {
      margin: 10px 0;
      padding: 10px 15px;
      background-color: green;
      color: white;
      border: none;
      cursor: pointer;
    }
    .user-cursor {
      position: absolute;
      width: 2px;
      background-color: red;
      z-index: 100;
    }
    .username-label {
      position: absolute;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      padding: 2px 5px;
      font-size: 12px;
      border-radius: 3px;
      z-index: 101;
    }
    #output {
      white-space: pre-wrap;
      background: #f4f4f4;
      padding: 10px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1>Collaborative Code Editor</h1>
  <div id="editor"></div>
  <button id="run-button">Run Code</button>
  <div id="output"></div>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor/min/vs/loader.js"></script>
  <script>
    const username = "client" + Math.floor(Math.random() * 1000);
    const clientId = Math.random().toString(36).substr(2, 9);

    const socket = new WebSocket('wss://spectrum-working-surf.glitch.me');
    let editor;
    let cursorDecorations = {};
    let isRemoteUpdate = false;

    // Setup Monaco Editor
    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor/min/vs' }});
    require(['vs/editor/editor.main'], function () {
      editor = monaco.editor.create(document.getElementById('editor'), {
        value: "// Start typing your code here...\n",
        language: 'javascript',
        theme: 'vs-dark'
      });

      // Listen for changes and send deltas to WebSocket server
      editor.onDidChangeModelContent((event) => {
        if (isRemoteUpdate) return;

        const changes = event.changes;
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'delta',
            data: {
              changes: changes,
              username: username,
              clientId: clientId
            }
          }));
        }
      });

      // Send cursor position updates to the server
      editor.onDidChangeCursorPosition((e) => {
        if (isRemoteUpdate) return;

        const position = editor.getPosition();
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            type: 'cursor',
            data: {
              username: username,
              position: position,
              clientId: clientId
            }
          }));
        }
      });

      // WebSocket listener for incoming deltas or cursor updates
      socket.onmessage = (event) => {
        if (event.data instanceof Blob) {
          const reader = new FileReader();
          reader.onload = () => {
            const message = JSON.parse(reader.result);
            if (message.data.clientId === clientId) return;

            if (message.type === 'delta') {
              isRemoteUpdate = true;
              applyDeltas(message.data.changes);
              isRemoteUpdate = false;
            } else if (message.type === 'cursor') {
              updateCursor(message.data);
            } else if (message.type === 'output') {
              displayOutput(message.data.output);
            }
          };
          reader.readAsText(event.data);
        }
      };

      // Apply deltas
      function applyDeltas(changes) {
        editor.executeEdits(null, changes.map(change => ({
          range: new monaco.Range(
            change.range.startLineNumber, change.range.startColumn,
            change.range.endLineNumber, change.range.endColumn
          ),
          text: change.text,
          forceMoveMarkers: change.forceMoveMarkers
        })));
      }

      // Update user cursor
      function updateCursor(cursorData) {
        const { username, position } = cursorData;
        if (username !== clientId) {
          showUserCursor(username, position);
        }
      }

      // Display output
      function displayOutput(output) {
        const outputElement = document.getElementById('output');
        outputElement.textContent = output;
      }

      // Run code on button click
      document.getElementById('run-button').addEventListener('click', async () => {
        const code = editor.getValue();
        const language = editor.getModel().getLanguageId();

        const result = await runCodeOnPiston(code, language);
        if (result) {
          socket.send(JSON.stringify({
            type: 'output',
            data: {
              output: result,
              clientId: clientId
            }
          }));
        }
      });

      // Piston API call
      async function runCodeOnPiston(code, language) {
        const response = await fetch('https://emkc.org/api/v2/piston/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            language: language || 'javascript',
            source: code
          })
        });

        const result = await response.json();
        return result.output || result.message;
      }

      // Show user cursor
      function showUserCursor(username, position) {
        const range = new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column);
        const options = { className: `user-cursor`, stickiness: 1 };

        if (cursorDecorations[username]) {
          editor.deltaDecorations(cursorDecorations[username], [{ range, options }]);
        } else {
          cursorDecorations[username] = editor.deltaDecorations([], [{ range, options }]);
        }

        const cursorCoords = editor.getScrolledVisiblePosition({ lineNumber: position.lineNumber, column: position.column });
        if (cursorCoords) {
          let label = document.querySelector(`.username-label[data-username="${username}"]`);
          if (!label) {
            label = document.createElement('div');
            label.className = 'username-label';
            label.dataset.username = username;
            document.body.appendChild(label);
          }
          label.textContent = username;
          const labelOffset = 100;
          label.style.left = `${cursorCoords.left}px`;
          label.style.top = `${cursorCoords.top + labelOffset}px`;
        }
      }
    });

    socket.onopen = () => console.log('WebSocket connection established');
    socket.onerror = error => console.error('WebSocket error:', error);
    socket.onclose = () => console.log('WebSocket connection closed');
  </script>
</body>
</html>
